name: Build Tesseract Bundles

on:
  workflow_dispatch:
    inputs:
      package:
        required: true

jobs:
  bundle:
    runs-on: windows-latest

    strategy:
      matrix:
        msystem: [UCRT64, CLANG64, CLANGARM64]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSYS2 (${{ matrix.msystem }})
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msystem }}
          update: true
          install: |
            mingw-w64-${{ matrix.msystem | lower }}-toolchain
            mingw-w64-${{ matrix.msystem | lower }}-tesseract-ocr
            mingw-w64-${{ matrix.msystem | lower }}-leptonica
            mingw-w64-${{ matrix.msystem | lower }}-libpng
            mingw-w64-${{ matrix.msystem | lower }}-libjpeg-turbo
            mingw-w64-${{ matrix.msystem | lower }}-libtiff
            mingw-w64-${{ matrix.msystem | lower }}-zlib

      - name: Create bundle (${{ matrix.msystem }})
        shell: msys2 {0}
        env:
          package: ${{ github.event.inputs.package }}
        run: ./build.sh

      - name: Release (${{ matrix.msystem }})
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.package }}-${{ steps.bundle.outputs.version }}-${{ matrix.msystem }}
          files: dist/*.xz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
